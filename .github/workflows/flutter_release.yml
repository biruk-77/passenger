name: ğŸš€ Flutter CI & Release

on:
  push:
    branches: ["main"]

permissions:
  contents: write   # REQUIRED for GitHub Releases

jobs:
  release:
    name: Build & Release Flutter App
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout repository
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # 2. Setup Java (Required for Android Build)
      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      # 3. Setup Flutter
      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: stable
          cache: true

      # 4. Clean & Install Dependencies
      - name: ğŸ“¦ Install dependencies
        run: |
          flutter clean
          flutter pub get

      # 5. Analyze Code
      - name: ğŸ” Analyze
        run: flutter analyze

      # 6. Build APK
      - name: ğŸ“± Build APK
        run: flutter build apk --release

      # 7. Build App Bundle (AAB)
      - name: ğŸ— Build App Bundle
        run: flutter build appbundle --release

      # 8. Build Web
      - name: ğŸŒ Build Web
        run: |
          if [ -d "web" ]; then
            flutter build web --release
            cd build
            zip -r web-release.zip web
          else
            echo "Web folder not found, skipping..."
          fi

      # 9. Create Release & Upload All Files
      - name: ğŸš€ Release & Upload
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/') || github.ref == 'refs/heads/main'
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: Release v1.0.${{ github.run_number }}
          body: |
            ğŸš€ Automated Build
            - Contains APK, AAB, and Web build.
          files: |
            build/app/outputs/flutter-apk/app-release.apk
            build/app/outputs/bundle/release/app-release.aab
            build/web-release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
