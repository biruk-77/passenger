name: ğŸš€ Flutter CI & Release

on:
  push:
    branches: ["main"]

permissions:
  contents: write   # REQUIRED for GitHub Releases

jobs:
  release:
    name: Build & Release Flutter App
    runs-on: ubuntu-latest

    steps:
      # Checkout repository
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4

      # Setup Flutter
      - name: ğŸ¦ Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.19.6"
          channel: stable
          cache: true

      # Verify Flutter
      - name: âœ… Flutter version
        run: flutter --version

      # Install dependencies
      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      # Analyze
      - name: ğŸ” Analyze
        run: flutter analyze

      # Build APK
      - name: ğŸ“± Build APK
        run: flutter build apk --release

      # Build AAB
      - name: ğŸ— Build App Bundle
        run: flutter build appbundle --release

      # Build Web (safe)
      - name: ğŸŒ Build Web
        run: |
          if [ -d "web" ]; then
            flutter build web --release
          else
            echo "Web not enabled, skipping"
          fi

      # Zip Web Build
      - name: ğŸ“¦ Zip Web Build
        run: |
          if [ -d "build/web" ]; then
            cd build
            zip -r web-release.zip web
          fi

      # Create GitHub Release
      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.run_number }}
          name: Flutter Release v${{ github.run_number }}
          body: |
            ğŸš€ Automated Flutter Release

            Included:
            - Android APK
            - Android App Bundle (AAB)
            - Web Build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload APK
      - name: ğŸ“¤ Upload APK
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/flutter-apk/app-release.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload AAB
      - name: ğŸ“¤ Upload AAB
        uses: softprops/action-gh-release@v2
        with:
          files: build/app/outputs/bundle/release/app-release.aab
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Upload Web ZIP
      - name: ğŸ“¤ Upload Web
        uses: softprops/action-gh-release@v2
        with:
          files: build/web-release.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
